<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoSlut - Roblox Gallery</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #ff69b4;
      --secondary: #ff1493;
      --dark: #1a1a1a;
      --light: #ffffff;
    }
    /* Reset và loại bỏ hiệu ứng tap highlight, focus outline */
    *,
    *::before,
    *::after {
      -webkit-tap-highlight-color: transparent;
    }
    button:focus,
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      box-shadow: none;
    }
    /* Tổng quan trang */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      color: var(--light);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    /* Thông báo chung */
    .global-notice {
      text-align: center;
      font-size: 1.1rem;
      color: #ccc;
      margin-bottom: 20px;
    }
    /* Featured Male Section */
    .featured-male {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .featured-male img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--light);
    }
    .featured-male .info {
      text-align: left;
    }
    .featured-male .info h3 {
      margin: 0;
      font-size: 1.4rem;
    }
    .featured-male .info p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      color: #ccc;
    }
    /* Grid hiển thị Players */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }
    .slot {
      position: relative;
      aspect-ratio: 1;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .slot:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.3);
      background: rgba(255,255,255,0.1);
    }
    .slot::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 15px;
      padding: 2px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .slot:hover::before {
      opacity: 1;
    }
    .add-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1.2rem;
      color: rgba(255,255,255,0.5);
      transition: all 0.3s;
    }
    .add-btn:hover {
      color: var(--primary);
    }
    .avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 15px;
    }
    .user-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      border-radius: 0 0 15px 15px;
    }
    .username {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Tag Idol */
    .idol-tag {
      display: inline-block;
      background: var(--secondary);
      color: #fff;
      padding: 2px 6px;
      font-size: 0.8rem;
      border-radius: 4px;
      margin-top: 4px;
    }
    /* Modal chung cho Add/Edit và Gallery */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: rgba(40,40,40,0.95);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .input-group {
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s;
    }
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,105,180,0.2);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    @media (max-width:768px) {
      .grid { grid-template-columns: repeat(3, 1fr); gap: 15px; }
      .slot { border-radius: 12px; }
    }
    @media (max-width:480px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
      .username { font-size: 1rem; }
    }
    /* --- Giao diện Profile theo phong cách Roblox --- */
    .profile-modal-content {
      background: rgba(40,40,40,0.95);
      border-radius: 20px;
      overflow: hidden;
      width: 90%;
      max-width: 700px;
      position: relative;
    }
    .profile-banner {
      position: relative;
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
      border-radius: 10px;
      background-blend-mode: overlay, multiply;
      filter: contrast(1.1) saturate(1.2);
      animation: gradientShift 8s ease infinite;
    }
    @keyframes gradientShift {
      0% { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
      25% { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
      50% { background: linear-gradient(135deg, #fad0c4, #ffd1ff); }
      75% { background: linear-gradient(135deg, #ffecd2, #fcb69f); }
      100% { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
    }
    .profile-banner::before {
      content: "";
      position: absolute;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      top: 10px;
      left: 10px;
      animation: rotateShape 5s linear infinite;
    }
    @keyframes rotateShape {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .profile-banner::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: rgba(255,255,255,0.4);
      animation: slideStripe 4s linear infinite;
    }
    @keyframes slideStripe {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .profile-banner .floating-shape {
      position: absolute;
      width: 30px;
      height: 30px;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-45%, -45%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    .profile-banner .banner-text {
      position: absolute;
      bottom: 10px;
      left: 20px;
      font-size: 3rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
      animation: fadeIn 2s ease-out, pulse 3s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .profile-banner .banner-decor {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 0.8rem;
      color: #fff;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
      animation: slideIn 3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    /* Profile Details */
    .profile-details {
      display: flex;
      padding: 70px 30px 20px;
      background: #222;
      position: relative;
      align-items: center;
    }
    .profile-avatar {
      position: absolute;
      top: -50px;
      left: 30px;
      width: 100px;
      height: 100px;
      border: 5px solid var(--light);
      border-radius: 50%;
      overflow: hidden;
      background: #fff;
      z-index: 2;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-info {
      margin-left: 110px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .profile-name-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .profile-info h2 {
      margin: 0;
      font-size: 1.8rem;
    }
    .btn-edit {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
    }
    /* Sắp xếp username và icon copy gần display name */
    .profile-userinfo {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      color: rgba(204,204,204,0.8);
    }
    .btn-copy {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-copy:hover {
      color: var(--secondary);
    }
    .profile-info p {
      margin: 5px 0 0;
      color: #ccc;
    }
    /* Currently Wearing Gallery */
    .currently-wearing {
      padding: 20px 30px;
      background: #1f1f1f;
    }
    .currently-wearing h3 {
      margin-top: 0;
      font-size: 1.4rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .gallery-slot {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
    }
    .gallery-slot img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .gallery-slot.add-slot {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gallery-slot.add-slot i {
      font-size: 2rem;
      color: var(--primary);
    }
    .profile-buttons {
      padding: 15px 30px;
      background: #222;
      text-align: right;
    }
    /* Nâng cấp nút Add Image (Modal Gallery) */
    .btn-add-image {
      background: linear-gradient(45deg, #ff69b4, #ff1493);
      color: #fff;
      border: none;
      padding: 12px 20px;
      font-size: 1.1rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .btn-add-image:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 10px rgba(0,0,0,0.3);
    }
    .btn-add-image:active {
      transform: scale(0.98);
    }
    #gallery-modal .modal-content {
      max-width: 400px;
    }
    /* --- Phần Search kết quả khi nhập username --- */
    .search-results {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .search-result-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-result-item:hover {
      background: rgba(255,255,255,0.1);
    }
    .search-result-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    .search-result-info {
      display: flex;
      flex-direction: column;
    }
    .search-result-info span {
      font-size: 0.9rem;
    }
    .search-result-info .display-name {
      font-weight: bold;
    }
    /* --- Overlay badge cho gallery: hiển thị "with taokotenl" --- */
    .gallery-badge {
      position: absolute;
      bottom: 2px;
      left: 2px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-gamepad"></i> RoSlut Gallery</h1>
    <!-- Thông báo chung -->
    <div class="global-notice">
      Tất cả ảnh đều có sự tham gia của <strong>taokotenl (VTriP_Official)</strong>
    </div>
    <!-- Featured Male Section -->
    <div class="featured-male">
      <img src="https://via.placeholder.com/150?text=taokotenl" alt="taokotenl">
      <div class="info">
        <h3>VTriP_Official</h3>
        <p>taokotenl</p>
      </div>
    </div>
    <!-- Grid hiển thị Players (nhân vật nữ) -->
    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal Thêm/Sửa Player (nhập username, chọn is idol & Search) -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 style="margin-top: 0;"><i class="fas fa-user-plus"></i> Add New Player</h3>
      <div class="input-group">
        <input type="text" id="username" placeholder="Enter Roblox Username">
      </div>
      <div class="input-group">
        <label>
          <input type="checkbox" id="isIdol"> Is Idol (TikTok/YouTube)
        </label>
      </div>
      <div class="button-group">
        <button class="btn-primary" onclick="searchUsers()">Search</button>
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      </div>
      <div id="search-results" class="search-results"></div>
    </div>
  </div>

  <!-- Modal Profile -->
  <div class="modal" id="profile-modal">
    <div class="profile-modal-content">
      <div class="profile-banner">
        <div class="floating-shape"></div>
        <div class="banner-text">RoSlut</div>
        <div class="banner-decor">Powered By VTriP Official</div>
      </div>
      <div class="profile-details">
        <div class="profile-avatar">
          <img id="profile-avatar" src="" alt="Avatar">
        </div>
        <div class="profile-info">
          <div class="profile-name-container">
            <h2 id="profile-username">Display Name</h2>
            <button class="btn-edit" onclick="openEditModal()"><i class="fas fa-edit"></i></button>
          </div>
          <div class="profile-userinfo">
            <span id="profile-actual-username">@username</span>
            <button class="btn-copy" onclick="copyUsername()" title="Copy Username"><i class="fas fa-copy"></i></button>
          </div>
          <!-- Nếu là idol, hiển thị tag -->
          <div id="idol-tag-container"></div>
          <p id="profile-description">Welcome to my Roblox profile!</p>
        </div>
      </div>
      <div class="currently-wearing">
        <h3>Currently Wearing</h3>
        <div class="gallery-grid" id="profile-gallery">
          <!-- Gallery images will be rendered here -->
        </div>
      </div>
      <div class="profile-buttons">
        <button class="btn-secondary" onclick="closeProfileModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal Gallery (Upload file vào Firebase Storage; cho phép chọn nhiều ảnh) -->
  <div class="modal" id="gallery-modal">
    <div class="modal-content">
      <h3 style="margin-top: 0;"><i class="fas fa-image"></i> Upload Gallery Images</h3>
      <div class="input-group">
        <input type="file" id="gallery-image-file" accept="image/*" multiple>
      </div>
      <div class="button-group">
        <button class="btn-add-image" onclick="uploadGalleryImage()">Upload Images</button>
        <button class="btn-secondary" onclick="closeGalleryModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase Initialization & Import Storage/Database -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";
    import { getDatabase, ref as dbRef, set, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyA8C6uB6L33k5mUPl2RnToj1A1uPaORnL0",
      authDomain: "alig-licpi-vtrip.firebaseapp.com",
      databaseURL: "https://alig-licpi-vtrip-default-rtdb.firebaseio.com",
      projectId: "alig-licpi-vtrip",
      storageBucket: "alig-licpi-vtrip.appspot.com",
      messagingSenderId: "801782379272",
      appId: "1:801782379272:web:d302610a16e5f5ee0ef2bd",
      measurementId: "G-DF9LG7MTVV"
    };
    
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const storage = getStorage(app);
    const database = getDatabase(app);
    
    // Expose Firebase functions/variables to window để sử dụng trong JS không dùng module
    window.app = app;
    window.getStorage = getStorage;
    window.storageRef = storageRef;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.getDatabase = getDatabase;
    window.dbRef = dbRef;
    window.setFirebase = set;
    window.onValueFirebase = onValue;
    window.database = database;
  </script>

  <!-- Main JS (non-module) -->
  <script>
    // Khi add player, lưu luôn thuộc tính "id" từ Roblox API để cập nhật avatar sau này
    let players = JSON.parse(localStorage.getItem('roslut_players')) || [];
    let currentSlot = null;
    let currentPlayerIndex = null;
    let currentProfileIndex = null;
    
    // Hàm cập nhật avatar cho tất cả các player khi web load (nếu có id)
    function updateAvatarsForPlayers() {
      if (players.length === 0) {
        renderSlots();
        return;
      }
      const ids = players.map(player => player.id).filter(Boolean).join(',');
      if (!ids) {
        renderSlots();
        return;
      }
      const proxy = "https://thingproxy.freeboard.io/fetch/";
      fetch(proxy + `https://thumbnails.roblox.com/v1/users/avatar?userIds=${ids}&size=720x720&format=png&isCircular=false`)
        .then(response => response.json())
        .then(data => {
          players.forEach(player => {
            const avatarData = data.data.find(item => item.targetId == player.id);
            if (avatarData) {
              player.avatar = avatarData.imageUrl;
            }
          });
          localStorage.setItem('roslut_players', JSON.stringify(players));
          renderSlots();
        })
        .catch(err => {
          console.error(err);
          renderSlots();
        });
    }
    
    function renderSlots() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      players.forEach((player, index) => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        // Hiển thị displayName nếu có, fallback username; nếu là idol, thêm tag nhỏ
        slot.innerHTML = player.avatar ? `
          <img src="${player.avatar}" class="avatar" loading="lazy">
          <div class="user-info">
            <p class="username">${player.displayName || player.username}</p>
            ${player.isIdol ? `<span class="idol-tag"><i class="fas fa-star"></i> Idol</span>` : ""}
          </div>
        ` : `
          <div class="add-btn">
            <i class="fas fa-plus-circle fa-3x"></i>
            <span>Add Player</span>
          </div>
        `;
        slot.onclick = () => player.avatar ? showProfile(index) : openModal(index);
        grid.appendChild(slot);
      });
      if (players.length < 25) {
        const addSlot = document.createElement('div');
        addSlot.className = 'slot add-btn';
        addSlot.innerHTML = `
          <i class="fas fa-plus-circle fa-3x"></i>
          <span>Add Player</span>
        `;
        addSlot.onclick = () => openModal(players.length);
        grid.appendChild(addSlot);
      }
    }
    
    function openModal(slotIndex) {
      currentSlot = slotIndex;
      currentPlayerIndex = null;
      document.getElementById('username').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('modal').style.display = 'flex';
      document.querySelector('.btn-primary').textContent = 'Search';
    }
    
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }
    
    // Sử dụng proxy để vượt qua CORS
    function searchUsers() {
      const username = document.getElementById('username').value.trim();
      if (!username) { alert('Please enter a username.'); return; }
      const proxy = "https://thingproxy.freeboard.io/fetch/";
      fetch(proxy + `https://users.roblox.com/v1/users/search?keyword=${encodeURIComponent(username)}&limit=10`)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data.data);
        })
        .catch(err => {
          console.error(err);
          alert('Error searching users.');
        });
    }
    
    function displaySearchResults(results) {
      const container = document.getElementById('search-results');
      container.innerHTML = '';
      if (!results || results.length === 0) {
        container.innerHTML = '<p>No users found.</p>';
        return;
      }
      const ids = results.map(user => user.id).join(',');
      const proxy = "https://thingproxy.freeboard.io/fetch/";
      fetch(proxy + `https://thumbnails.roblox.com/v1/users/avatar?userIds=${ids}&size=720x720&format=png&isCircular=false`)
        .then(response => response.json())
        .then(thumbData => {
          results.forEach(user => {
            const avatarObj = thumbData.data.find(item => item.targetId == user.id);
            const avatarUrl = avatarObj ? avatarObj.imageUrl : 'https://via.placeholder.com/100';
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
              <img class="search-result-avatar" src="${avatarUrl}" alt="Avatar">
              <div class="search-result-info">
                <span class="display-name">${user.displayName}</span>
                <span class="username">@${user.name}</span>
              </div>
            `;
            item.onclick = () => {
              const isIdol = document.getElementById("isIdol").checked;
              const newPlayer = {
                id: user.id,
                username: user.name,
                displayName: user.displayName,
                avatar: avatarUrl,
                isIdol: isIdol,
                images: [],
                lastUpdated: new Date().toISOString()
              };
              players.splice(currentSlot, 0, newPlayer);
              localStorage.setItem('roslut_players', JSON.stringify(players));
              // Lưu player vào Firebase Realtime Database
              window.setFirebase(window.dbRef(window.database, "players/" + newPlayer.username), newPlayer);
              renderSlots();
              closeModal();
            };
            container.appendChild(item);
          });
        })
        .catch(err => {
          console.error(err);
          alert('Error fetching avatars.');
        });
    }
    
    function showProfile(index) {
      currentProfileIndex = index;
      const player = players[index];
      document.getElementById('profile-username').textContent = player.displayName || player.username;
      document.getElementById('profile-actual-username').textContent = "@" + player.username;
      document.getElementById('profile-avatar').src = player.avatar || 'https://via.placeholder.com/100';
      document.getElementById('profile-description').textContent = "Welcome to my Roblox profile!";
      // Nếu là idol, hiển thị tag trên profile
      const idolTagContainer = document.getElementById('idol-tag-container');
      idolTagContainer.innerHTML = player.isIdol ? `<span class="idol-tag"><i class="fas fa-star"></i> Idol</span>` : "";
      document.getElementById('profile-modal').style.display = 'flex';
      const playerRef = window.dbRef(window.database, "players/" + player.username);
      window.onValueFirebase(playerRef, snapshot => {
        const data = snapshot.val();
        if (data && data.images) {
          player.images = data.images;
          localStorage.setItem('roslut_players', JSON.stringify(players));
        }
        renderProfileGallery(player);
      });
    }
    
    function closeProfileModal() {
      document.getElementById('profile-modal').style.display = 'none';
    }
    
    function openEditModal() {
      if (currentProfileIndex !== null) {
        currentPlayerIndex = currentProfileIndex;
        const player = players[currentProfileIndex];
        document.getElementById('username').value = player.username;
        document.getElementById('modal').style.display = 'flex';
        document.querySelector('.btn-primary').textContent = 'Search';
      }
    }
    
    function renderProfileGallery(player) {
      const gallery = document.getElementById('profile-gallery');
      gallery.innerHTML = '';
      if (player.images && player.images.length > 0) {
        player.images.forEach(imgObj => {
          const slot = document.createElement('div');
          slot.className = 'gallery-slot';
          const imageEl = document.createElement('img');
          imageEl.src = imgObj.url;
          // Thêm tag thời gian
          const timeTag = document.createElement('div');
          timeTag.className = 'gallery-badge';
          timeTag.textContent = formatTime(imgObj.timestamp);
          // Thêm nút lưu ảnh về máy
          const saveBtn = document.createElement('button');
          saveBtn.style.position = 'absolute';
          saveBtn.style.top = '2px';
          saveBtn.style.right = '2px';
          saveBtn.style.background = 'none';
          saveBtn.style.border = 'none';
          saveBtn.style.color = '#fff';
          saveBtn.style.cursor = 'pointer';
          saveBtn.title = 'Save image';
          saveBtn.innerHTML = '<i class="fas fa-download"></i>';
          saveBtn.onclick = (e) => {
            e.stopPropagation();
            saveImage(imgObj);
          };
          slot.appendChild(imageEl);
          slot.appendChild(timeTag);
          slot.appendChild(saveBtn);
          gallery.appendChild(slot);
        });
      }
      const addSlot = document.createElement('div');
      addSlot.className = 'gallery-slot add-slot';
      addSlot.innerHTML = `<i class="fas fa-plus-circle"></i>`;
      addSlot.onclick = openGalleryModal;
      gallery.appendChild(addSlot);
    }
    
    function openGalleryModal() {
      document.getElementById('gallery-image-file').value = "";
      document.getElementById('gallery-modal').style.display = 'flex';
    }
    
    function closeGalleryModal() {
      document.getElementById('gallery-modal').style.display = 'none';
    }
    
    // Upload file lên Firebase Storage, hỗ trợ nhiều file cùng lúc
    function uploadGalleryImage() {
      const fileInput = document.getElementById('gallery-image-file');
      const files = fileInput.files;
      if (!files.length) { alert("Please select one or more image files."); return; }
      const player = players[currentProfileIndex];
      const uploadPromises = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = encodeURIComponent(file.name);
        const ref = window.storageRef(window.getStorage(window.app), 'gallery/' + player.username + '/' + fileName);
        const promise = window.uploadBytes(ref, file)
          .then(snapshot => window.getDownloadURL(snapshot.ref))
          .then(url => ({ url: url, timestamp: Date.now() }));
        uploadPromises.push(promise);
      }
      Promise.all(uploadPromises)
        .then(results => {
          results.forEach(result => {
            player.images.push(result);
          });
          localStorage.setItem('roslut_players', JSON.stringify(players));
          window.setFirebase(window.dbRef(window.database, "players/" + player.username + "/images"), player.images);
          renderProfileGallery(player);
          renderSlots();
          closeGalleryModal();
        })
        .catch(err => {
          console.error(err);
          alert("Upload failed: " + err.message);
        });
    }
    
    // Hàm định dạng thời gian (ví dụ "1 giây trước", "1p trước", "1giờ trước", "1 năm trước")
    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      if (seconds < 60) return seconds + " giây trước";
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + "p trước";
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + "giờ trước";
      const days = Math.floor(hours / 24);
      if (days < 365) return days + " ngày trước";
      const years = Math.floor(days / 365);
      return years + " năm trước";
    }
    
    // Hàm lưu ảnh về máy (mở URL ảnh trong tab mới)
    function saveImage(imageObj) {
      window.open(imageObj.url, "_blank");
    }
    
    // Hàm sao chép username
    function copyUsername() {
      const username = document.getElementById('profile-actual-username').textContent;
      navigator.clipboard.writeText(username)
        .then(() => { alert('Username copied!'); })
        .catch(err => { console.error('Failed to copy: ', err); });
    }
    
    // Khi truy cập lại web, cập nhật avatar của tất cả các player nếu có id
    function updateAvatarsForPlayers() {
      if (players.length === 0) {
        renderSlots();
        return;
      }
      const ids = players.map(player => player.id).filter(Boolean).join(',');
      if (!ids) {
        renderSlots();
        return;
      }
      const proxy = "https://thingproxy.freeboard.io/fetch/";
      fetch(proxy + `https://thumbnails.roblox.com/v1/users/avatar?userIds=${ids}&size=720x720&format=png&isCircular=false`)
        .then(response => response.json())
        .then(data => {
          players.forEach(player => {
            const avatarData = data.data.find(item => item.targetId == player.id);
            if (avatarData) {
              player.avatar = avatarData.imageUrl;
            }
          });
          localStorage.setItem('roslut_players', JSON.stringify(players));
          renderSlots();
        })
        .catch(err => {
          console.error(err);
          renderSlots();
        });
    }
    
    window.onload = updateAvatarsForPlayers;
  </script>
</body>
</html>
